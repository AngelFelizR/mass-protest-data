---
title: "Analizing Protests from 1990 to 2022"
author: "Angel Feliz"
date: "`r format(Sys.Date(),'%d %B %Y')`"
output: 
  html_document:
    highlight: textmate
    theme: united
    toc: true
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.align = "center", fig.dim = c(12,8))
```

<style>
h1.title{ font-size: 35px;}

h2.title{font-size: 30px;}

.my-red {color: red;}

</style>

# Introduction

Protests are an important part of society change. In this time we are going to explore data from **The Mass Mobilization Project** which contains information about protests against governments, and contains a variety of variables such as location, dates and number of participants. The data is available in this [link](https://github.com/datacamp/careerhub-data/tree/master/Mass%20Protest%20Data)

This opens the possibility to understand:

1. Where do protest occurs?
2. Why do people protest?
3. Which kind of people participate in protests?
4. How do states react to protest?

To answer those questions we will perform an **Exploratory Data Analysis (EDA)** applying the next skills:

- Data wrangling (data.table)
- Date manipulation (lubridate)
- String manipulation with regular expressions (stringr)
- Data visualization (ggplot2, scales, forcats)
- Interactive data visualization (plotly, crosstalk)
- Automatic report generation (rmarkdown, html, css)

# 1. Initial set up

## 1.1. Libraries importation 

```{r}
library(data.table)
library(lubridate)
library(stringr)
library(countrycode)
library(flextable)
library(ggplot2)
library(scales)
library(forcats)
library(plotly)
library(crosstalk)

theme_set(theme_light())
```

## 1.2. Defining initial vectors

We are going to use to this values to extract the number of participants from the `participants` columns.

- `words_after_number` lists many common words that can be after a number.
- `words_before_number` lists many common words that can be before a number.

```{r}

words_after_number <- 
str_c(c("people","protesters","drivers","residents","supporters",
        "members","participants","former","demonstrators"),
      collapse = "|")


words_before_number <-
str_c(c("about","around","more than",">","<","almost","over","more than"),
      collapse = "|")


old_countries <- rep("Europe",5)
names(old_countries) <-  c("Yugoslavia", "Serbia and Montenegro",
                           "Kosovo","Germany East","Czechoslovakia")

```


# 2. Data wrangling

In this sections we are going to apply all the changes needed to make easy explore the data in other steps.  

## 2.1. Data importation and cleanning

In this section we do the next steps:

- Taking out rows that aren't related to a protest event.
- Save protest's start and end dates as **Date** variables.
- Adding `continent` column based on `country` column.
- Completing `participants_category` columns based on `participants` column.
- Taking out unnecessary columns.

```{r}

# Importing protest_data.csv in to R and 
# protest start and end dates as Date variables
protest_raw <-
fread("Raw-data/protest_data.csv", na.strings = "", integer64 = "double"
  )[protest == 1
  ][,`:=`(start_date =  paste(startyear,startmonth,startday,sep = "-") |> as_date(),
          end_date =  paste(endyear,endmonth,endday,sep = "-") |> as_date())]


# Adding continent based on countries names
countries <- protest_raw[! country %chin% names(old_countries), unique(country)]
countries_continent <- countrycode(countries, origin = "country.name",
                                   destination = "continent")
names(countries_continent) <- countries
countries_continent <- c(countries_continent,old_countries)
protest_raw[, continent := countries_continent[country]]


protest_data <-
  
# Completing the participants_category columns based on participants column
protest_raw[, participants := str_to_lower(participants) |> 
      str_remove_all(",") |>
      str_replace_all(" +"," ")
  ][, c("min","max") := tstrsplit(participants,"-| to ", fixed = FALSE)
  ][participants %like% "between \\d+ and \\d+", 
    `:=`(min = str_match(participants, "between (\\d+) and \\d+")[,2],
         max = str_match(participants, "between \\d+ and (\\d+)")[,2])
  ][, c("min","max") := lapply(.(min, max), function(x) str_extract(x, "\\d+") |> 
                                 as.double())
  ][, participants_clean := (min+max)/2
  ][ participants %like% "^\\d+$" & is.na(participants_clean),
     participants_clean := participants |> as.double()
  ][participants %like% "\\+"& is.na(participants_clean),
    participants_clean := participants |> str_remove_all("\\+|[A-Za-z]") |> 
      as.double()
  ][participants %like% "\\d+s"& is.na(participants_clean),
    participants_clean :=  str_match(participants,"(\\d+)s")[,2] |> 
      as.double()
  ][participants %like% str_glue("\\d+ ?({words_after_number})") &
      is.na(participants_clean),
    participants_clean := str_match(participants,
       pattern = str_glue("(\\d+) ?({words_after_number})"))[,2] |> as.double()
  ][participants %like% "\\d+ ?families" & is.na(participants_clean),
    participants_clean := str_match(participants, pattern = "(\\d+) ?families")[,2] |>
      as.double() * 3
  ][participants %like% str_glue("({words_before_number}) ?\\d+") &
      is.na(participants_clean),
    participants_clean := str_match(participants,
       pattern = str_glue("({words_before_number}) ?(\\d+)"))[,3] |> as.double()
  ][id == 922006004, participants_clean := 50
  ][id == 6602002005, participants_clean := 2000
  ][, participants_category_clean := 
      fcase( between(participants_clean, 1, 99), "1-99",
             between(participants_clean, 100, 999), "100-999",
             between(participants_clean, 1000, 1999), "1000-1999",
             between(participants_clean, 2000, 4999), "2000-4999",
             between(participants_clean, 5000, 10000), "5000-10000",
             participants_clean > 10000, ">10000",
             default = "Missing")
  ][is.na(participants_category), participants_category :=  participants_category_clean
  ][participants_category == "50-99", participants_category := "1-99"
  ][, participants_category := factor(participants_category,
                                      levels = c("Missing","1-99", "100-999", 
                                                 "1000-1999",  "2000-4999", 
                                                 "5000-10000",">10000"))
    
# Taking out unnecessary columns
  ][, !c("participants","participants_clean","participants_category_clean",'region',
         "startyear","startmonth","startday","endyear","endmonth","endday", "protest",
         "min","max")
    
# Setting the col order for data.frame
  ][, setcolorder(.SD, 
                  union(c('id', 'country', 'ccode', 'year', "continent",
                          'protestnumber','protesterviolence', 'location', 
                          "participants_category","start_date","end_date"),
                        names(.SD)))]


protest_data[1:6, !c("sources","notes")] |>
  flextable() |>
  theme_vanilla() |>
  autofit()

```


## 2.2. Reshaping the data

In this step we reshape columns starting with `protesterdemand` or `stateresponse` into `variable`, `actions` and `happen`.

```{r}

response_tidy <-
protest_data[, melt(.SD, 
                    id.vars = "id",
                    measure.vars = str_subset(names(.SD),"^protesterdemand|^stateresponse"),
                    value.name = "actions",
                    variable.factor = FALSE)
  ][!is.na(actions)
  ][, variable := fifelse(variable %like% "^protesterdemand", 
                          "protester_demand","state_response")
  ][, `:=` (happen = TRUE,
            actions = str_c(variable," - ",actions))
  ][, !c("variable")
  ][, unique(.SD)
  ][, merge(.SD,
            CJ(id = unique(protest_data$id),
               actions = unique(actions)),
            by = c("id", "actions"), all = TRUE)
  ][is.na(happen), happen := FALSE
  ][, c("variable", "actions") := tstrsplit(actions, split = " - ", fixed = TRUE)
  ][,c("id","variable","actions","happen")]


protest_data_tidy <-
protest_data[, .SD, .SDcols = !patterns("^protesterdemand|^stateresponse")
  ][, merge(.SD,
            response_tidy,
            by = "id", all = TRUE)
  ][, setcolorder(.SD, setdiff(names(.SD), c("sources","notes")))]

protest_data_tidy[1:6, !c("sources","notes")] |>
  flextable() |>
  theme_vanilla() |>
  autofit()

```


# 3. Data exploration

Now we can use the data to answer the questions proposed in the introduction.


## 3.1. Where do protests occur?

As our data has **`r length(countries_continent)`** countries it's better to explore the data by continent and then by country as we continue exploring.

```{r}

continent_summary <-
protest_data_tidy[, .(number_protest = uniqueN(id)),
                  .(continent)
  ][order(-number_protest)
  ][, continent := as_factor(continent)
  ][, pct := cumsum(number_protest)/sum(number_protest)]

continent_levels <-levels(continent_summary$continent)

ggplot(continent_summary,aes(number_protest, fct_rev(continent), fill = continent))+
  geom_col()+
  geom_text(aes(label = percent(pct, accuracy = 0.1)), hjust = -0.3)+
  geom_blank(aes(x = number_protest *1.15))+
  scale_x_continuous(labels = comma_format(accuracy = 1))+
  labs(title = "Number of Protests per Continent",
       x = "Number of Protests", y = "Continent" )+
  theme(legend.position = "none",
        plot.title = element_text(color = "black",
                                  face = "bold"),
        strip.text = element_text(face = "bold"),
        panel.grid.major.y = element_blank())

```

As we can see in the chart most of the protests occurs in **`r continent_summary[, continent][1]`** and  **`r continent_summary[, continent][2]`**.

As this data have information of protests between *`r protest_data_tidy[, min(year)]`* and *`r protest_data_tidy[, max(year)]`* let's see how the number of protests change each year for each continent.

```{r, fig.align='center', fig.dim = c(10,6)}

continent_count_year_plot <-
protest_data_tidy[, .(number_protest = uniqueN(id)),
                  .(continent = factor(continent, 
                                       levels = continent_levels),
                    year)] |>
  SharedData$new(key = ~continent, group = "Select a continent") |>
  ggplot(aes(year, number_protest, color = continent))+
  geom_line(size = 1)+
  geom_point(size = 2)+
  scale_y_continuous(breaks = breaks_width(50))+
  scale_x_continuous(breaks = breaks_width(2))+
  labs(title = "Number of Protests per Continent and Year",
       x = "Year", y = "Number of Protests", color = "Continent")+
  theme(plot.title = element_text(color = "black", face = "bold"))

  ggplotly(continent_count_year_plot) |>
    highlight(on = 'plotly_click',
              off = 'plotly_doubleclick')

```

At first view, we can see that *2020* isn't a normal year as countries have less protests that year than any other year in the past. That abnormality makes sense when we check that he last date in data is <span style="color:red">  ***`r protest_data_tidy[,max(c(start_date,end_date))] |> format("%m/%d/%y")`***</span>.

Checking each individual Continent by clicking over each one we can see:

- **Europe:** Only *`r continent_count_year_plot$data[continent == "Europe",  mean(number_protest > 150)|> percent()]`* of years have more than 150 per year and would be interesting to under why was the people protesting in **1990**, **1996-1997** and **2013-2019**.

- **Asia:** The number of protests per year increased from less than 100 protests per year to 159 between **1997 and 2000**, then between **2005 and 2006** and 3 high picks in **2011**, **2014** and **2019**.

- **Africa:** The number of protest had a pick in **2005**, an increase tendency between **2010 and 2012**, two important picks in **2015** and **2019**.

- **America:** It has to important picks in **2015** and **2019**.

- **Oceania:** It just have two picks of 5 protest in **2001** and **2005**.


