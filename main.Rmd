---
title: "Analizing Protests from 1990 to 2020"
author: "Angel Feliz"
date: "`r format(Sys.Date(),'%d %B %Y')`"
output: 
  html_document:
    css: styles.css
    code_folding: show
    highlight: tango
    theme: united
    toc: true
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.align = "center", fig.dim = c(12,8))
```

<style>


</style>

# Introduction

Protests are an important part of society change. In this post we are going to explore data from **The Mass Mobilization Project** which contains information about protests against governments, and contains a variety of variables such as location, dates and number of participants. The data was obtained by this [link](https://github.com/datacamp/careerhub-data/tree/master/Mass%20Protest%20Data)

This data opens the possibility to understand:

1. Where do protest occurs?
2. Why do people protest?
3. How do states react to protest?
4. Which kind of people participate in protests?

To answer those questions we will perform an **Exploratory Data Analysis (EDA)** applying the next skills:

- R (functional) programming with ***base R***
- Data Manipulation with ***data.table***
- Date manipulation with ***lubridate***
- String manipulation with ***stringr***
- Data visualization with ***ggplot2***, ***scales*** and ***forcats***
- Interactive data visualization with ***plotly*** and ***crosstalk***
- Automated reporting with ***rmarkdown***, ***flextable***, ***html*** and ***css***
- Text mining with ***tidytext***


```{r initial-set-up, class.source = 'fold-hide'}

# Libraries importation
library(data.table)
library(lubridate)
library(stringr)
library(countrycode)
library(flextable)
library(ggplot2)
library(scales)
library(forcats)
library(plotly)
library(crosstalk)

theme_set(theme_light())


# Vectors to clean data
words_after_number <- 
str_c(c("people","protesters","drivers","residents","supporters",
        "members","participants","former","demonstrators"),
      collapse = "|")

words_before_number <-
str_c(c("about","around","more than",">","<","almost","over","more than"),
      collapse = "|")

old_countries_EUR <-  
c("Yugoslavia", "Serbia and Montenegro",
  "Kosovo","Germany East","Czechoslovakia")


# Custom functions

#  count_category
#   It counts the unique number of id_var for category included in group_var
#   returning a list with a plot and a vector with the levels of the group_var.
#   
#   Arguments
#    DATA: A data.table with data to count.
#    id_var: A character value that defines the id column to count the events.
#    group_var: A character value that defines the column to group by.
#    plot_title: A character value that defines the plot title.
#    plot_max: A numeric value that defines the number of categories 
#              that will appear in the plot.

count_category <- function(DATA,
                           id_var,
                           group_var,
                           plot_title,
                           plot_max,
                           plot_fill){
  
  
region_summary <-
 DATA[, setnames(.SD, c(id_var,group_var), c("id","region"))
  ][, .(number_protest = uniqueN(id)), region
  ][order(-number_protest)
  ][, region := as_factor(region)
  ][, pct := cumsum(number_protest)/sum(number_protest)]


if(missing(plot_max) || nrow(region_summary) <= plot_max){
  plot_data <- region_summary
}else{
  plot_data <- region_summary[1:plot_max]
}


if(missing(plot_fill)){
 base_aes <- 
   ggplot(plot_data,aes(number_protest, fct_rev(region))) +
   geom_col(aes(fill = region))
}else{
 base_aes <-
   ggplot(plot_data,aes(number_protest, fct_rev(region))) +
   geom_col(fill = plot_fill)
}


plot <-
 base_aes +
  geom_text(aes(label = percent(pct, accuracy = 0.1)), hjust = -0.3, size = 6)+
  geom_blank(aes(x = number_protest *1.08))+
  scale_x_continuous(labels = comma_format(accuracy = 1))+
  labs(title = plot_title, x = "", y = "" )+
  theme(legend.position = "none",
        plot.title = element_text(color = "black", face = "bold", 
                                  size = 22, hjust = 0.5),
        axis.title = element_text(color = "black", face = "bold", size = 18),
        axis.text = element_text(color = "black", size = 16),
        strip.text = element_text(face = "bold"),
        panel.grid.major.y = element_blank())

list("plot" = plot,"levels" = levels(region_summary$region) )
  
}

```


# 2. Data wrangling

Before being able to explore the data it's important to face some problems with the data. The next table summarizes the problems founds in the data and the problems to solve each problem:

<table class = "wrangling-table">
 <thead>
  <tr>
    <th>Order</th> 
    <th>Problems</th> 
    <th>Solutions</th> 
  </tr>
 </thead>
 <tbody>
  <tr>
    <td>01</td> 
    <td>Many rows don't represent a protest to analyze.</td> 
    <td>We took those rows off.</td> 
  </tr>
  <tr>
    <td>02</td> 
    <td>Days, months and years were stored in individual columns to define protest start and end date.</td> 
    <td>We created a Date variable to define the protest start and end dates.</td> 
  </tr>
  <tr>
    <td>03</td> 
    <td>`participants_category` column has a good number of categories but have many missing values and `participants` mixes value with words</td> 
    <td>We cleaned `participants` and then complete the `participants_category` with that information.</td> 
   </tr>
    <tr>
    <td>04</td> 
    <td>Protester demands and state responses were stored in many columns as one protest can have many values</td> 
    <td>We reshape the data to have longer table where protester demands and state responses are saved in 3 columns without missing values.</td> 
   </tr>
   
  </tbody>
</table>


```{r}

protest_data <-
  
  # Importing protest_data.csv in to R and 
fread("Raw-data/protest_data.csv", na.strings = "", integer64 = "double"
  )[protest == 1
    
    
  # protest start and end dates as Date variables
  ][,`:=`(start_date =  paste(startyear,startmonth,startday,sep = "-") |> as_date(),
          end_date =  paste(endyear,endmonth,endday,sep = "-") |> as_date())
    
    
  # Adding continent based on countries names
  ][!country %chin% old_countries_EUR, 
    continent := countrycode(country, 
                             origin = "country.name",
                             destination = "continent")
  ][country %chin% old_countries_EUR, continent := "Europe"
  
    
  # Completing the participants_category columns based on participants column
  ][, participants := str_to_lower(participants) |> 
      str_remove_all(",") |>
      str_replace_all(" +"," ")
  ][, c("min","max") := tstrsplit(participants,"-| to ", fixed = FALSE)
  ][participants %like% "between \\d+ and \\d+", 
    `:=`(min = str_match(participants, "between (\\d+) and \\d+")[,2],
         max = str_match(participants, "between \\d+ and (\\d+)")[,2])
  ][, c("min","max") := lapply(.(min, max), function(x) str_extract(x, "\\d+") |> 
                                 as.double())
  ][, participants_clean := (min+max)/2
  ][ participants %like% "^\\d+$" & is.na(participants_clean),
     participants_clean := participants |> as.double()
  ][participants %like% "\\+"& is.na(participants_clean),
    participants_clean := participants |> str_remove_all("\\+|[A-Za-z]") |> 
      as.double()
  ][participants %like% "\\d+s"& is.na(participants_clean),
    participants_clean :=  str_match(participants,"(\\d+)s")[,2] |> 
      as.double()
  ][participants %like% str_glue("\\d+ ?({words_after_number})") &
      is.na(participants_clean),
    participants_clean := str_match(participants,
       pattern = str_glue("(\\d+) ?({words_after_number})"))[,2] |> as.double()
  ][participants %like% str_glue("({words_before_number}) ?\\d+") &
      is.na(participants_clean),
    participants_clean := str_match(participants,
       pattern = str_glue("({words_before_number}) ?(\\d+)"))[,3] |> as.double()
  ][id == 922006004, participants_clean := 50
  ][id == 6602002005, participants_clean := 2000
  ][, participants_category_clean := 
      fcase( between(participants_clean, 1, 99), "1-99",
             between(participants_clean, 100, 999), "100-999",
             between(participants_clean, 1000, 1999), "1000-1999",
             between(participants_clean, 2000, 4999), "2000-4999",
             between(participants_clean, 5000, 10000), "5000-10000",
             participants_clean > 10000, ">10000",
             default = "Missing")
  ][is.na(participants_category), participants_category :=  participants_category_clean
  ][participants_category == "50-99", participants_category := "1-99"
  ][, participants_category := factor(participants_category,
                                      levels = c("Missing","1-99", "100-999", 
                                                 "1000-1999",  "2000-4999", 
                                                 "5000-10000",">10000"))
    
    
  # Taking out unnecessary columns
  ][, !c("participants","participants_clean","participants_category_clean",'region',
         "startyear","startmonth","startday","endyear","endmonth","endday", "protest",
         "min","max")
    
    
  # Setting the col order for data.frame
  ][, setcolorder(.SD, 
                  union(c('id', 'country', 'ccode', 'year', "continent",
                          'protestnumber','protesterviolence', 'location', 
                          "participants_category","start_date","end_date"),
                        names(.SD)))]


# Changing protester demands and state responses to a longer format
response_tidy <-
protest_data[, melt(.SD, 
                    id.vars = "id",
                    measure.vars = str_subset(names(.SD),
                                              "^protesterdemand|^stateresponse"),
                    value.name = "actions",
                    variable.factor = FALSE)
  ][!is.na(actions) & actions %like% "\\w"
  ][, variable := fifelse(variable %like% "^protesterdemand", 
                          "protester_demand","state_response")
  ][, `:=` (happen = TRUE,
            actions = str_c(variable," - ",actions))
  ][, !c("variable")
  ][, unique(.SD)
  ][, merge(.SD,
            CJ(id = unique(protest_data$id),
               actions = unique(actions)),
            by = c("id", "actions"), all = TRUE)
  ][is.na(happen), happen := FALSE
  ][, c("variable", "actions") := tstrsplit(actions, split = " - ", fixed = TRUE)
  ][,c("id","variable","actions","happen")]


# Joining protester demands and state responses in a longer format
protest_data_tidy <-
protest_data[, .SD, .SDcols = !patterns("^protesterdemand|^stateresponse")
  ][, merge(.SD,
            response_tidy,
            by = "id", all = TRUE)
  ][, setcolorder(.SD, setdiff(names(.SD), c("protesteridentity","notes","sources")))]


# Show final table
protest_data_tidy[id == id[1], 
                  !c("protestnumber", "protesterviolence","location","continent",
                     "year","ccode","protesteridentity","notes","sources")
  ][, id := as.character(id)] |>
  flextable() |>
  theme_vanilla() |>
  autofit()
```


# 3. Data exploration

Now we can use the data to answer the questions proposed in the introduction.


## 3.1. Where do protests occur?

### 3.1.1. Continent level

As our data has **`r uniqueN(protest_data_tidy$country)`** countries it's better to explore the data by continent and then by country as we continue exploring.

```{r}

continent_summary <-
count_category(protest_data_tidy,
               id_var = "id",
               group_var = "continent",
               plot_title = "Number of Protests per Continent")


#Saving the levels in our data to keep the same colors for each continent
protest_data_tidy[, continent := factor(continent,
                                        levels = continent_summary$levels)]

continent_summary$plot

```


As we can see in the chart most of the protests occurs in **`r continent_summary$levels[1]`** and  **`r continent_summary$levels[2]`**.

As this data have information of protests between *`r protest_data_tidy[, min(year)]`* and *`r protest_data_tidy[, max(year)]`* let's see how the number of protests change each year for each continent.

```{r, fig.align='center', fig.dim = c(10,6)}

continent_count_year_plot <-
protest_data_tidy[, .(number_protest = uniqueN(id)),
                  .(continent, year)] |>
  SharedData$new(key = ~continent, group = "Select a continent") |>
  ggplot(aes(year, number_protest, color = continent))+
  geom_line(size = 1)+
  geom_point(size = 2)+
  scale_y_continuous(breaks = breaks_width(50))+
  scale_x_continuous(breaks = breaks_width(2))+
  labs(title = "Number of Protests per Continent and Year",
       x = "Year", y = "Number of Protests", color = "Continent")+
  theme(plot.title = element_text(color = "black", face = "bold"))

  ggplotly(continent_count_year_plot) |>
    highlight(on = 'plotly_click',
              off = 'plotly_doubleclick')

```

At first view, we can see that *2020* isn't a normal year as countries have less protests that year than any other year in the past. That abnormality makes sense when we check that he last date in data is ***`r protest_data_tidy[,max(c(start_date,end_date))] |> format("%m/%d/%y")`***.

Checking each individual Continent by clicking over each one we can see:

- **Europe:** Only *`r continent_count_year_plot$data[continent == "Europe",  mean(number_protest > 150)|> percent()]`* of years have more than 150 per year and would be interesting to under why was the people protesting in **1990**, **1996-1997** and **2013-2019**.

- **Asia:** The number of protests per year increased from less than 100 protests per year to 159 between **1997 and 2000**, then between **2005 and 2006** and 3 high picks in **2011**, **2014** and **2019**.

- **Africa:** The number of protest had a pick in **2005**, an increase tendency between **2010 and 2012**, two important picks in **2015** and **2019**.

- **America:** It has to important picks in **2015** and **2019**.

- **Oceania:** It just have two picks of 5 protest in **2001** and **2005**.


```{r eval=FALSE, include=FALSE}
count_category(protest_data_tidy[variable == "protester_demand" &
                                   happen == TRUE &
                                   continent == "Asia"],
               id_var = "id",
               group_var = "actions",
               plot_title = "Number of Protests per Continent",
               plot_fill = "forestgreen")

count_category(protest_data_tidy[variable == "state_response" & 
                                   happen == TRUE &
                                   continent == "Americas"],
               id_var = "id",
               group_var = "actions",
               plot_title = "Number of Protests per Continent",
               plot_fill = "forestgreen")

count_category(protest_data_tidy[continent == "Europe"],
               id_var = "id",
               group_var = "country",
               plot_title = "Number of Protests per European Country",
               plot_fill = "forestgreen")
```
